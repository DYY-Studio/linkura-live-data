name: Resource Version Check

permissions:
  contents: write

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/10 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-res-version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version-check.outputs.new_version }}
      version: ${{ steps.version-check.outputs.version }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
    
    - name: Run resource version check
      id: version-check
      run: |
        cd scripts
        chmod +x handle_res_version.sh
        if ./handle_res_version.sh; then
          echo "new_version=true" >> $GITHUB_OUTPUT
          # è·å–æ–°ç‰ˆæœ¬å·ç”¨äºcommitä¿¡æ¯
          NEW_VERSION=$(head -n 1 ../data/res_version.txt)
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°æ–°çš„èµ„æºç‰ˆæœ¬: $NEW_VERSION"
        else
          echo "new_version=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–°çš„èµ„æºç‰ˆæœ¬"
        fi
    
    - name: Configure Git
      if: steps.version-check.outputs.new_version == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Get the current date time
      id: datetime
      if: steps.version-check.outputs.new_version == 'true'
      run: echo "time_now=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
    
    - name: Commit and push changes
      if: steps.version-check.outputs.new_version == 'true'
      uses: EndBug/add-and-commit@v9
      with:
        default_author: github_actions
        message: 'res version(${{ steps.datetime.outputs.time_now }}): ${{ steps.version-check.outputs.version }}'
        add: |
          - data/res_version.txt
    
    - name: Create summary
      run: |
        if [ "${{ steps.version-check.outputs.new_version }}" == "true" ]; then
          echo "âœ… æ£€æµ‹åˆ°æ–°çš„èµ„æºç‰ˆæœ¬: ${{ steps.version-check.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ å·²æäº¤æ›´æ–°åˆ°ä»“åº“" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–°çš„èµ„æºç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
        fi

  notification:
    runs-on: ubuntu-latest
    needs: check-res-version
    if: always()  # æ— è®ºæ˜¯å¦æœ‰æ–°ç‰ˆæœ¬éƒ½å‘é€é€šçŸ¥
    
    steps:
    - name: Send Uptime notification
      run: |
        # æ„å»ºæ¶ˆæ¯å†…å®¹
        if [ "${{ needs.check-res-version.outputs.new_version }}" == "true" ]; then
          MSG="æ£€æµ‹åˆ°æ–°çš„èµ„æºç‰ˆæœ¬: ${{ needs.check-res-version.outputs.version }}"
          STATUS="up"
        else
          MSG="èµ„æºç‰ˆæœ¬æ£€æŸ¥å®Œæˆï¼Œæ— æ–°ç‰ˆæœ¬"
          STATUS="up"
        fi
        
        # URLç¼–ç æ¶ˆæ¯
        ENCODED_MSG=$(echo "$MSG" | python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.stdin.read().strip()))")
        
        # æ„å»ºå®Œæ•´çš„URL
        UPTIME_URL="${{ secrets.UPTIME_URL_RES_CHECK }}?status=up&ping=&msg=${ENCODED_MSG}"
        
        echo "å‘é€é€šçŸ¥: $MSG"
        echo "ç¼–ç åçš„æ¶ˆæ¯: $ENCODED_MSG"
        
        # å‘é€è¯·æ±‚ï¼Œæ·»åŠ User-Agentå’Œå…¶ä»–headersæ¥ç»•è¿‡Cloudflare
        curl -L \
          -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36" \
          -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
          -H "Accept-Language: en-US,en;q=0.5" \
          -H "Accept-Encoding: gzip, deflate" \
          -H "Connection: keep-alive" \
          -H "Upgrade-Insecure-Requests: 1" \
          --max-time 30 \
          "$UPTIME_URL" || echo "Uptimeé€šçŸ¥å‘é€å¤±è´¥"
