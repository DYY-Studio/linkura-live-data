name: Resource Version Check

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/10 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-res-version:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
    
    - name: Run resource version check
      id: version-check
      run: |
        cd scripts
        chmod +x handle_res_version.sh
        if ./handle_res_version.sh; then
          echo "new_version=true" >> $GITHUB_OUTPUT
          # èŽ·å–æ–°ç‰ˆæœ¬å·ç”¨äºŽcommitä¿¡æ¯
          NEW_VERSION=$(head -n 1 ../data/res_version.txt)
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°æ–°çš„èµ„æºç‰ˆæœ¬: $NEW_VERSION"
        else
          echo "new_version=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–°çš„èµ„æºç‰ˆæœ¬"
        fi
    
    - name: Configure Git
      if: steps.version-check.outputs.new_version == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push changes
      if: steps.version-check.outputs.new_version == 'true'
      run: |
        git add data/res_version.txt
        git commit -m "resç‰ˆæœ¬: ${{ steps.version-check.outputs.version }}"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create summary
      run: |
        if [ "${{ steps.version-check.outputs.new_version }}" == "true" ]; then
          echo "âœ… æ£€æµ‹åˆ°æ–°çš„èµ„æºç‰ˆæœ¬: ${{ steps.version-check.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ å·²æäº¤æ›´æ–°åˆ°ä»“åº“" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–°çš„èµ„æºç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
        fi
